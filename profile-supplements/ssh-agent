SSH_ADD=$(which ssh-add)
SSH_AGENT=$(which ssh-agent)

if [ -x "${SSH_AGENT}" ] && [ -x "${SSH_ADD}" ]; then
  SSH_ENV="${HOME}/.ssh/environment"

  start_agent() {
    echo "Initialising new SSH agent..."
    "${SSH_AGENT}" | sed 's/^echo/#echo/' > "${SSH_ENV}"
    chmod 600 "${SSH_ENV}"
    . "${SSH_ENV}" > /dev/null
    "${SSH_ADD}"
  }

  if [ -f "${SSH_ENV}" ]; then
    . "${SSH_ENV}" > /dev/null
    pidof ssh-agent > /dev/null 2>&1 || {
      start_agent
    }
  else
    start_agent
  fi 
fi